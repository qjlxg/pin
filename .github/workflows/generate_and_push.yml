name: Generate and Push Trojan Links

# ------------------------------------------
# è§¦å‘äº‹ä»¶é…ç½®
# ------------------------------------------
on:
  # 1. æ‰‹åŠ¨è§¦å‘ (å¯ä»¥ä» Actions é¡µé¢æ‰‹åŠ¨è¿è¡Œ)
  workflow_dispatch:
    inputs:
      reason:
        description: 'æ‰‹åŠ¨è¿è¡Œçš„åŸå›  (å¯é€‰)'
        required: false
        default: 'Manual run via GitHub UI'

  # 2. å®šæ—¶è¿è¡Œ (æ¯å¤© UTC 01:00ï¼Œè½¬æ¢ä¸ºä¸Šæµ·æ—¶åŒºä¸º 09:00)
  schedule:
    # æ¯å¤©æ—©ä¸Š 9 ç‚¹ï¼ˆä¸Šæµ·æ—¶åŒºï¼‰è¿è¡Œ
    - cron: '0 1 * * *' 

  # 3. æ–‡ä»¶å˜åŠ¨è‡ªåŠ¨è¿è¡Œ
  push:
    branches:
      - master # æ›¿æ¢ä¸ºæ‚¨çš„ä¸»åˆ†æ”¯åç§°
      - main   # æ›¿æ¢ä¸ºæ‚¨çš„ä¸»åˆ†æ”¯åç§°
    paths:
      # ç›‘æ§ä»¥ä¸‹æ–‡ä»¶çš„å˜åŠ¨
      - 'link.txt'
      - 'generate_config.py'
      - '.github/workflows/generate_and_push.yml'

# ------------------------------------------
# å…¨å±€æ—¶åŒºè®¾ç½® (ä¸Šæµ·æ—¶åŒº)
# ------------------------------------------
env:
  TZ: Asia/Shanghai

jobs:
  generate_and_push:
    runs-on: ubuntu-latest
    
    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
      - name: Checkout Repository
        uses: actions/checkout@v4
        # å¿…é¡»è®¾ç½® token å’Œ fetch-depthï¼Œä»¥ä¾¿åç»­èƒ½å¤Ÿæ¨é€
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0 

      # æ­¥éª¤ 2: è®¾ç½® Python ç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x' 

      # æ­¥éª¤ 3: å®‰è£…ä¾èµ– (å¦‚æœè„šæœ¬æœ‰ä¾èµ–ï¼Œè¿™é‡Œæ·»åŠ )
      # - name: Install dependencies
      #   run: |
      #     python -m pip install --upgrade pip
      #     pip install -r requirements.txt # å¦‚æœæœ‰

      # æ­¥éª¤ 4: è¿è¡Œ Python è„šæœ¬ç”Ÿæˆé“¾æ¥æ–‡ä»¶
      - name: Run Python Script to Generate Links
        run: python generate_config.py

      # æ­¥éª¤ 5: æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜åŠ¨ (æ–°ç”Ÿæˆçš„ trojan_links.txt)
      - name: Check for Changes
        id: git_status
        run: |
          # æ£€æŸ¥å·¥ä½œåŒºæ˜¯å¦æœ‰æœªæäº¤çš„æ›´æ”¹
          if git diff --exit-code --name-only; then
            echo "::set-output name=has_changes::false"
          else
            echo "::set-output name=has_changes::true"
          fi
          
      # æ­¥éª¤ 6: æäº¤å¹¶æ¨é€æ–‡ä»¶å˜åŠ¨
      - name: Commit and Push Changes
        if: steps.git_status.outputs.has_changes == 'true'
        run: |
          # è®¾ç½® Git ç”¨æˆ·ä¿¡æ¯
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

          # æ·»åŠ ç”Ÿæˆçš„æ–‡ä»¶
          git add trojan_links.txt

          # æäº¤æ›´æ”¹
          commit_message="ğŸ¤– Auto-update: Generated trojan_links.txt [$(date +%Y-%m-%d\ %H:%M:%S)]"
          git commit -m "${commit_message}" 

          # æ¨é€æ›´æ”¹åˆ°ä»“åº“
          git push
