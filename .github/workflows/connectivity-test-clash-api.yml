# .github/workflows/connectivity-test-clash-api.yml
name: æµ‹è¯• (Mihomo/Clash.Meta æœ¬åœ°è½¬æ¢)

on:
  # 1. å…è®¸æ‰‹åŠ¨è¿è¡Œ
  workflow_dispatch:
  
  # 2. è„šæœ¬æˆ–æ ¸å¿ƒæ–‡ä»¶å˜åŠ¨æ—¶è‡ªåŠ¨è§¦å‘
  push:
    branches:
      - main # è¯·æ ¹æ®æ‚¨çš„ä¸»åˆ†æ”¯åç§°è¿›è¡Œä¿®æ”¹
    paths:
      - 'test_connectivity_clash_api.py'
      - 'mihomo-linux-amd64'
      - 'subconverter/**' # ç¡®ä¿ç›‘æµ‹ subconverter ç›®å½•å†…çš„æ–‡ä»¶å˜åŒ–
      - '.github/workflows/connectivity-test-clash-api.yml'
      
jobs:
  test_and_push:
    runs-on: ubuntu-latest
    
    # æˆäºˆå†™å…¥æƒé™ï¼Œå…è®¸æœºå™¨äººæ¨é€æ–°çš„ç»“æœæ–‡ä»¶
    permissions:
      contents: write 
    
    # è®¾ç½®ä¸Šæµ·æ—¶åŒº
    env:
      TZ: 'Asia/Shanghai'

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 
          
      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: âš™ï¸ å®‰è£…ä¾èµ– (requests, pytz)
        run: pip install requests pytz

      - name: ğŸ’¾ æ£€æŸ¥ Mihomo æ ¸å¿ƒ (mihomo-linux-amd64)
        run: |
          MIHOMO_EXEC="./mihomo-linux-amd64"
          if [ ! -f "$MIHOMO_EXEC" ]; then
            echo "::error::Mihomo æ ¸å¿ƒæ–‡ä»¶ $MIHOMO_EXEC æœªæ‰¾åˆ°ï¼Œè¯·ç¡®ä¿å·²ä¸Šä¼ åˆ°ä»“åº“æ ¹ç›®å½•ã€‚"
            exit 1
          fi
          chmod +x "$MIHOMO_EXEC"
          echo "âœ… Mihomo æ ¸å¿ƒæ£€æŸ¥æˆåŠŸï¼Œå·²æˆæƒæ‰§è¡Œã€‚"

      - name: âš™ï¸ æ£€æŸ¥ Subconverter æ ¸å¿ƒ (æ™ºèƒ½ä¿®å¤è·¯å¾„)
        id: check-subconverter
        run: |
          # è„šæœ¬æœŸæœ›çš„æœ€ç»ˆè·¯å¾„
          SUB_EXEC_FINAL="./subconverter-linux64"
          
          # 1. æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨äºæœŸæœ›è·¯å¾„ (å¦‚æœç”¨æˆ·ä¹‹å‰é‡å‘½åæˆåŠŸ)
          if [ -f "$SUB_EXEC_FINAL" ]; then
            echo "âœ… Subconverter å·²ä½äºæœŸæœ›è·¯å¾„ã€‚"
          
          # 2. æ£€æŸ¥ç›®å½•è·¯å¾„ (å¦‚æœç”¨æˆ·ä¸Šä¼ äº† subconverter ç›®å½•)
          elif [ -f "./subconverter/subconverter" ]; then
            echo "âš ï¸ åœ¨ './subconverter/subconverter' è·¯å¾„æ‰¾åˆ°æ–‡ä»¶ï¼Œæ­£åœ¨ç§»åŠ¨å’Œé‡å‘½å..."
            # ç§»åŠ¨æ–‡ä»¶å¹¶é‡å‘½å
            mv subconverter/subconverter "$SUB_EXEC_FINAL"
            # æ¸…ç†ç›®å½• (å¯é€‰)
            rm -rf subconverter 
            echo "âœ… æˆåŠŸç§»åŠ¨å¹¶é‡å‘½åä¸º $SUB_EXEC_FINALã€‚"
            
          else
            echo "::error::Subconverter å¯æ‰§è¡Œæ–‡ä»¶æœªæ‰¾åˆ°ã€‚è¯·ç¡®è®¤æ–‡ä»¶å·²ä¸Šä¼ åˆ°ä»“åº“æ ¹ç›®å½•ï¼Œä¸”è·¯å¾„ä¸º $SUB_EXEC_FINAL æˆ– subconverter/subconverterã€‚"
            exit 1
          fi

          # 3. æˆæƒæ‰§è¡Œ
          chmod +x "$SUB_EXEC_FINAL"
          echo "âœ… Subconverter å·²æˆæƒæ‰§è¡Œã€‚"

      - name: ğŸƒ æ‰§è¡Œ Mihomo æµ‹è¯•è„šæœ¬
        id: run-script
        run: |
          # è¿è¡Œè„šæœ¬
          python test_connectivity_clash_api.py | tee run_output.txt
          
          # ä»è„šæœ¬è¾“å‡ºä¸­æå– REPORT_PATH å˜é‡
          REPORT_PATH=$(grep 'REPORT_PATH=' run_output.txt | cut -d'=' -f2)
          echo "REPORT_PATH=$REPORT_PATH" >> $GITHUB_OUTPUT
        
      - name: â¬†ï¸ æ¨é€æµ‹è¯•ç»“æœåˆ°ä»“åº“
        if: steps.run-script.outputs.REPORT_PATH != ''
        run: |
          REPORT_PATH=${{ steps.run-script.outputs.REPORT_PATH }}
          
          if [ ! -f "$REPORT_PATH" ]; then
            echo "âŒ æŠ¥å‘Šæ–‡ä»¶æœªæ‰¾åˆ°ï¼Œè·³è¿‡æ¨é€ã€‚"
            exit 0
          fi
          
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          
          git add $REPORT_PATH
          
          if ! git diff-index --quiet HEAD; then
            DATE_SHANGHAI=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')
            git commit -m "è‡ªåŠ¨æµ‹è¯•: æˆåŠŸèŠ‚ç‚¹æŠ¥å‘Š ${DATE_SHANGHAI} (æœ¬åœ°è½¬æ¢)"
            
            git pull --rebase origin ${GITHUB_REF#refs/heads/} 
            git push
          else
            echo "æŠ¥å‘Šæ–‡ä»¶æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤ã€‚"
          fi
