# .github/workflows/connectivity-test-clash-api.yml
name: æµ‹è¯• (Mihomo/Clash.Meta æœ¬åœ°è½¬æ¢)

on:
  # 1. å…è®¸æ‰‹åŠ¨è¿è¡Œ
  workflow_dispatch:
  
  # 2. è„šæœ¬æˆ–æ ¸å¿ƒæ–‡ä»¶å˜åŠ¨æ—¶è‡ªåŠ¨è§¦å‘
  push:
    branches:
      - main # è¯·æ ¹æ®æ‚¨çš„ä¸»åˆ†æ”¯åç§°è¿›è¡Œä¿®æ”¹
    paths:
      - 'test_connectivity_clash_api.py'
      - 'mihomo-linux-amd64'
      - '.github/workflows/connectivity-test-clash-api.yml'
      
jobs:
  test_and_push:
    runs-on: ubuntu-latest
    
    # æˆäºˆå†™å…¥æƒé™ï¼Œå…è®¸æœºå™¨äººæ¨é€æ–°çš„ç»“æœæ–‡ä»¶
    permissions:
      contents: write 
    
    # è®¾ç½®ä¸Šæµ·æ—¶åŒº
    env:
      TZ: 'Asia/Shanghai'

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          # å…è®¸åç»­æ­¥éª¤æ¨é€æ–°çš„æäº¤
          fetch-depth: 0 
          
      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: âš™ï¸ å®‰è£…ä¾èµ– (requests, pytz)
        run: pip install requests pytz

      - name: ğŸ’¾ æ£€æŸ¥ Mihomo æ ¸å¿ƒ
        run: |
          MIHOMO_EXEC="./mihomo-linux-amd64"
          if [ ! -f "$MIHOMO_EXEC" ]; then
            echo "::error::Mihomo æ ¸å¿ƒæ–‡ä»¶ $MIHOMO_EXEC æœªæ‰¾åˆ°ï¼Œè¯·ç¡®ä¿å·²ä¸Šä¼ åˆ°ä»“åº“æ ¹ç›®å½•ã€‚"
            exit 1
          fi
          chmod +x "$MIHOMO_EXEC"
          echo "Mihomo æ ¸å¿ƒæˆæƒæ‰§è¡ŒæˆåŠŸã€‚"

      - name: âš™ï¸ ä¸‹è½½ Subconverter å¯æ‰§è¡Œæ–‡ä»¶
        id: download-subconverter
        run: |
          # ä»ç¨³å®š Release v0.9.0 ä¸‹è½½ Linux AMD64 ç‰ˆæœ¬
          SUB_ARCHIVE_URL="https://github.com/tindy2013/subconverter/releases/download/v0.9.0/subconverter_linux64.tar.gz"
          ARCHIVE_NAME="subconverter.tar.gz"
          SUB_EXEC_FINAL="./subconverter-linux64" 

          echo "ä¸‹è½½ Subconverter å‹ç¼©åŒ…..."
          if ! curl -o "$ARCHIVE_NAME" -L "$SUB_ARCHIVE_URL"; then
            echo "::error::Subconverter ä¸‹è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥é“¾æ¥ã€‚"
            exit 1
          fi
          
          echo "è§£å‹ Subconverter..."
          tar -xzf "$ARCHIVE_NAME"
          
          # è§£å‹åçš„æ–‡ä»¶åä¸º subconverter
          if [ -f "subconverter" ]; then
            mv "subconverter" "$SUB_EXEC_FINAL"
          else
            echo "::error::è§£å‹åçš„ subconverter å¯æ‰§è¡Œæ–‡ä»¶æœªæ‰¾åˆ°ï¼Œè¯·æ£€æŸ¥ tar.gz å†…å®¹ã€‚"
            exit 1
          fi

          chmod +x "$SUB_EXEC_FINAL"
          echo "Subconverter ä¸‹è½½ã€è§£å‹å¹¶æˆæƒæ‰§è¡ŒæˆåŠŸï¼š$SUB_EXEC_FINAL"

      - name: ğŸƒ æ‰§è¡Œ Mihomo æµ‹è¯•è„šæœ¬
        id: run-script
        run: |
          # è¿è¡Œè„šæœ¬
          python test_connectivity_clash_api.py | tee run_output.txt
          
          # ä»è„šæœ¬è¾“å‡ºä¸­æå– REPORT_PATH å˜é‡
          REPORT_PATH=$(grep 'REPORT_PATH=' run_output.txt | cut -d'=' -f2)
          echo "REPORT_PATH=$REPORT_PATH" >> $GITHUB_OUTPUT
        
      - name: â¬†ï¸ æ¨é€æµ‹è¯•ç»“æœåˆ°ä»“åº“
        if: steps.run-script.outputs.REPORT_PATH != ''
        run: |
          REPORT_PATH=${{ steps.run-script.outputs.REPORT_PATH }}
          
          if [ ! -f "$REPORT_PATH" ]; then
            echo "âŒ æŠ¥å‘Šæ–‡ä»¶æœªæ‰¾åˆ°ï¼Œè·³è¿‡æ¨é€ã€‚"
            exit 0
          fi
          
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          
          git add $REPORT_PATH
          
          if ! git diff-index --quiet HEAD; then
            DATE_SHANGHAI=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')
            git commit -m "è‡ªåŠ¨æµ‹è¯•: æˆåŠŸèŠ‚ç‚¹æŠ¥å‘Š ${DATE_SHANGHAI} (æœ¬åœ°è½¬æ¢)"
            
            # ä½¿ç”¨ --rebase é¿å…äº§ç”Ÿåˆå¹¶å†²çª
            git pull --rebase origin ${GITHUB_REF#refs/heads/} 
            git push
          else
            echo "æŠ¥å‘Šæ–‡ä»¶æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤ã€‚"
          fi
