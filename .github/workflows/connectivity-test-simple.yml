# .github/workflows/connectivity-test-simple.yml
name: èŠ‚ç‚¹è¿é€šæ€§æµ‹è¯• (ç®€åŒ–ç‰ˆ)

on:
  # 1. å…è®¸æ‰‹åŠ¨è¿è¡Œ
  workflow_dispatch:
  
  # 2. è„šæœ¬å˜åŠ¨æ—¶è‡ªåŠ¨è§¦å‘
  push:
    branches:
      - main # è¯·æ ¹æ®æ‚¨çš„ä¸»åˆ†æ”¯åç§°è¿›è¡Œä¿®æ”¹
    paths:
      - 'test_connectivity.sh'
      - '.github/workflows/connectivity-test-simple.yml'
      # å¦‚æœæ‚¨å°†è¿œç¨‹çš„ merged_configs.txt å’Œ config.yaml ä¹Ÿä¸‹è½½åˆ°æœ¬åœ°ä»“åº“äº†ï¼Œ
      # å¯ä»¥å°†å®ƒä»¬çš„æœ¬åœ°è·¯å¾„ä¹ŸåŠ å…¥åˆ° paths åˆ—è¡¨ä¸­ï¼Œä»¥ä¾¿å˜åŠ¨æ—¶è§¦å‘ã€‚
      
jobs:
  test_and_push:
    runs-on: ubuntu-latest
    
    # è®¾ç½®ä¸Šæµ·æ—¶åŒº
    env:
      TZ: 'Asia/Shanghai'

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # å…è®¸åç»­æ­¥éª¤æ¨é€æ–°çš„æäº¤
          
      - name: ğŸƒ æ‰§è¡Œè¿é€šæ€§æµ‹è¯•è„šæœ¬
        id: run-script
        # ç¡®ä¿è„šæœ¬æœ‰æ‰§è¡Œæƒé™
        # è¿è¡Œè„šæœ¬å¹¶å°†è¾“å‡ºï¼ˆåŒ…æ‹¬ REPORT_PATHï¼‰æ•è·åˆ° run_output.txt
        run: |
          chmod +x test_connectivity.sh
          ./test_connectivity.sh | tee run_output.txt
          
          # ä»è„šæœ¬è¾“å‡ºä¸­æå– REPORT_PATH å˜é‡ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          REPORT_PATH=$(grep 'REPORT_PATH=' run_output.txt | cut -d'=' -f2)
          echo "REPORT_PATH=$REPORT_PATH" >> $GITHUB_OUTPUT
        
      - name: â¬†ï¸ æ¨é€æµ‹è¯•ç»“æœåˆ°ä»“åº“
        # åªæœ‰å½“è„šæœ¬è¾“å‡ºäº† REPORT_PATH å¹¶ä¸”æ–‡ä»¶å­˜åœ¨æ—¶æ‰æ‰§è¡Œ
        if: steps.run-script.outputs.REPORT_PATH != '' && steps.run-script.outputs.REPORT_PATH != null
        run: |
          REPORT_PATH=${{ steps.run-script.outputs.REPORT_PATH }}
          
          if [ -f "$REPORT_PATH" ]; then
            git config user.name 'github-actions[bot]'
            git config user.email 'github-actions[bot]@users.noreply.github.com'
            
            # æ·»åŠ å…¥æ–°ç”Ÿæˆçš„æŠ¥å‘Šæ–‡ä»¶
            git add $REPORT_PATH
            
            # æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦æäº¤çš„æ›´æ”¹
            if ! git diff-index --quiet HEAD; then
              DATE_SHANGHAI=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')
              git commit -m "è‡ªåŠ¨æµ‹è¯•: æˆåŠŸèŠ‚ç‚¹æŠ¥å‘Š ${DATE_SHANGHAI} (ä¸Šæµ·æ—¶åŒº)"
              git push
              echo "âœ… æˆåŠŸæ¨é€äº†æ–°æŠ¥å‘Š: $REPORT_PATH"
            else
              echo "âš ï¸ ä»“åº“ä¸­æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹ã€‚"
            fi
          else
            echo "âŒ æŠ¥å‘Šæ–‡ä»¶æœªæ‰¾åˆ°ï¼Œè·³è¿‡æ¨é€ã€‚"
          fi
