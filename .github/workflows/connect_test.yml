name: ğŸŒ Node Connectivity Test (TCP Ping)

# é…ç½®å·¥ä½œæµçš„è§¦å‘æ¡ä»¶
on:
  # 1. å…è®¸æ‰‹åŠ¨è§¦å‘ (Workflow Dispatch)
  workflow_dispatch:
    inputs:
      reason:
        description: 'æ‰‹åŠ¨è¿è¡Œçš„åŸå›  (å¯é€‰)'
        required: false
        default: 'Manual test run'
        
  # 2. å®šæ—¶è§¦å‘
  schedule:
    # æ¯å¤© 00:00 UTC è¿è¡Œï¼Œå³ä¸Šæµ·æ—¶é—´ (UTC+8) çš„ 08:00
    - cron: '0 0 * * *' 
  
  # 3. å½“å…³é”®æ–‡ä»¶å˜åŠ¨æ—¶è‡ªåŠ¨è§¦å‘ (è‡ªåŠ¨è¿è¡Œ)
  push:
    paths:
      # å½“å·¥ä½œæµæ–‡ä»¶æˆ–è„šæœ¬æœ¬èº«å˜åŠ¨æ—¶è§¦å‘
      - '.github/workflows/connect_test.yml'
      - 'tcp_ping_test.sh'

# ã€å…³é”®ä¿®å¤ã€‘æ˜¾å¼æˆäºˆ GITHUB_TOKEN å†™å…¥æƒé™ï¼Œä»¥å…è®¸æäº¤æ–‡ä»¶
permissions:
  contents: write 

# å…¨å±€ç¯å¢ƒå˜é‡
env:
  TZ: 'Asia/Shanghai' # è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ·ï¼Œç”¨äºæ—¥å¿—ä¸­çš„æ—¶é—´æˆ³

jobs:
  run_test:
    # åœ¨æœ€æ–°çš„ Ubuntu ç¯å¢ƒä¸‹è¿è¡Œ
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: æ£€å‡ºä»“åº“ä»£ç 
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4
        
      # Step 2: èµ‹äºˆè„šæœ¬æ‰§è¡Œæƒé™
      - name: âš™ï¸ Set up Permissions
        run: chmod +x tcp_ping_test.sh
        
      # Step 3: æ‰§è¡Œ TCP Ping æµ‹è¯•è„šæœ¬
      - name: ğŸƒ Run TCP Connectivity Test
        id: test_script
        # è¿è¡Œè„šæœ¬ï¼Œå¹¶å°†è¾“å‡ºä¹Ÿå†™å…¥æ—¥å¿—æ–‡ä»¶
        run: ./tcp_ping_test.sh | tee script_output.log
        
      # Step 4: æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„è¿é€šèŠ‚ç‚¹æ–‡ä»¶ç”Ÿæˆ
      # æ³¨æ„ï¼šåœ¨ Bash ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨ $? æ¥åˆ¤æ–­ä¸Šä¸€ä¸ªå‘½ä»¤çš„æˆåŠŸä¸å¦ï¼Œ
      # ä½†è¿™é‡Œä¸»è¦æ˜¯æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”ä¸ä¸ºç©º
      - name: ğŸ” Check for Working Nodes
        id: check_file
        run: |
          if [ -s working_nodes.txt ]; then
            echo "::set-output name=file_exists::true"
          else
            echo "::set-output name=file_exists::false"
          fi
          
      # Step 5: å¦‚æœå­˜åœ¨è¿é€šèŠ‚ç‚¹ï¼Œåˆ™æäº¤åˆ°ä»“åº“
      # if æ¡ä»¶ç¡®ä¿åªæœ‰åœ¨æ‰¾åˆ°è¿é€šèŠ‚ç‚¹æ—¶æ‰æ‰§è¡Œæäº¤
      - name: ğŸ“¤ Commit Working Nodes
        if: steps.check_file.outputs.file_exists == 'true'
        uses: EndBug/add-and-commit@v9
        with:
          # ä½¿ç”¨é»˜è®¤çš„ GitHub Actions Bot ä½œä¸ºæäº¤è€…
          author_name: GitHub Actions Bot
          author_email: actions@github.com
          # è‡ªåŠ¨ç”ŸæˆåŒ…å«ä¸Šæµ·æ—¶åŒºçš„æäº¤ä¿¡æ¯
          message: "âœ… Auto update: Working nodes found [$(date +'%Y-%m-%d %H:%M:%S' -d @$(($(date +%s) + 8*3600)))]"
          # æ·»åŠ å·¥ä½œèŠ‚ç‚¹åˆ—è¡¨æ–‡ä»¶
          add: 'working_nodes.txt'
          # æ³¨æ„ï¼šæ­¤é…ç½®ä¼šè¦†ç›–åŸæœ‰çš„ working_nodes.txt æ–‡ä»¶
