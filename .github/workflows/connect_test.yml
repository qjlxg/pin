name: ğŸŒ Node Dual Connectivity Test (TCP & UDP)

# é…ç½®å·¥ä½œæµçš„è§¦å‘æ¡ä»¶
on:
  # 1. å…è®¸æ‰‹åŠ¨è§¦å‘ (Workflow Dispatch)
  workflow_dispatch:
    inputs:
      reason:
        description: 'æ‰‹åŠ¨è¿è¡Œçš„åŸå›  (å¯é€‰)'
        required: false
        default: 'Manual dual-test run'
        
  # 2. å®šæ—¶è§¦å‘
  schedule:
    # æ¯å¤© 00:00 UTC è¿è¡Œï¼Œå³ä¸Šæµ·æ—¶é—´ (UTC+8) çš„ 08:00
    - cron: '0 0 * * *' 
  
  # 3. å½“å…³é”®æ–‡ä»¶å˜åŠ¨æ—¶è‡ªåŠ¨è§¦å‘ (è‡ªåŠ¨è¿è¡Œ)
  push:
    paths:
      # å½“å·¥ä½œæµæ–‡ä»¶æˆ–è„šæœ¬æœ¬èº«å˜åŠ¨æ—¶è§¦å‘
      - '.github/workflows/connect_test.yml'
      - 'tcp_udp_test.sh' # è„šæœ¬å
      
# ã€æƒé™ä¿®å¤ã€‘æ˜¾å¼æˆäºˆ GITHUB_TOKEN å†™å…¥æƒé™ï¼Œä»¥å…è®¸æäº¤æ–‡ä»¶
permissions:
  contents: write 

# å…¨å±€ç¯å¢ƒå˜é‡
env:
  TZ: 'Asia/Shanghai' # è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ·ï¼Œç”¨äºæ—¥å¿—ä¸­çš„æ—¶é—´æˆ³

jobs:
  run_dual_test:
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: æ£€å‡ºä»“åº“ä»£ç 
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4
        
      # Step 2: å®‰è£…å¿…è¦çš„å·¥å…· (Netcat-openbsd ç”¨äº UDP, jq ç”¨äº JSON è§£æ, yq ç”¨äº YAML è§£æ)
      - name: ğŸ› ï¸ Install Netcat, jq, and yq
        # ç¡®ä¿å®‰è£…äº† netcat-openbsd (ä¿®å¤äº† netcat è™šæ‹ŸåŒ…é—®é¢˜)ã€jq å’Œ yq
        run: sudo apt-get update && sudo apt-get install -y netcat-openbsd jq yq
        
      # Step 3: èµ‹äºˆè„šæœ¬æ‰§è¡Œæƒé™
      - name: âš™ï¸ Set up Permissions
        run: chmod +x tcp_udp_test.sh
        
      # Step 4: æ‰§è¡Œ TCP & UDP è¿é€šæ€§æµ‹è¯•è„šæœ¬
      - name: ğŸƒ Run Dual Connectivity Test
        id: test_script
        # è¿è¡Œè„šæœ¬ï¼Œå¹¶å°†è¾“å‡ºä¹Ÿå†™å…¥æ—¥å¿—æ–‡ä»¶
        run: ./tcp_udp_test.sh | tee script_output.log
        
      # Step 5: æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„è¿é€šèŠ‚ç‚¹æ–‡ä»¶ç”Ÿæˆ
      # æ£€æŸ¥æ–‡ä»¶ (working_nodes_full.txt) æ˜¯å¦å­˜åœ¨ä¸”ä¸ä¸ºç©º
      - name: ğŸ” Check for Dual Working Nodes
        id: check_file
        # æ³¨æ„ï¼šæ­¤å¤„ä½¿ç”¨ ::set-output æ˜¯ Actions v3 ä»¥å‰çš„å†™æ³•ï¼Œä½†åœ¨æ­¤ç¯å¢ƒä¸­ä»å¯å…¼å®¹ã€‚
        run: |
          if [ -s working_nodes_full.txt ]; then
            echo "::set-output name=file_exists::true"
          else
            echo "::set-output name=file_exists::false"
          fi
          
      # Step 6: å¦‚æœå­˜åœ¨åŒé€šèŠ‚ç‚¹ï¼Œåˆ™æäº¤åˆ°ä»“åº“
      - name: ğŸ“¤ Commit Dual Working Nodes
        if: steps.check_file.outputs.file_exists == 'true'
        uses: EndBug/add-and-commit@v9
        with:
          author_name: GitHub Actions Bot
          author_email: actions@github.com
          # æäº¤ä¿¡æ¯ä½¿ç”¨ä¸Šæµ·æ—¶åŒºæ—¶é—´
          message: "âœ… Auto update: TCP/UDP Dual working nodes found [$(date +'%Y-%m-%d %H:%M:%S' -d @$(($(date +%s) + 8*3600)))]"
          # æäº¤åŒé€šèŠ‚ç‚¹åˆ—è¡¨æ–‡ä»¶
          add: 'working_nodes_full.txt'
