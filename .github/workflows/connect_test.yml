name: ğŸŒ Node Connectivity Test (TCP Ping)

# é…ç½®å·¥ä½œæµçš„è§¦å‘æ¡ä»¶
on:
  # 1. å…è®¸æ‰‹åŠ¨è§¦å‘ (Workflow Dispatch)
  workflow_dispatch:
    inputs:
      reason:
        description: 'æ‰‹åŠ¨è¿è¡Œçš„åŸå›  (å¯é€‰)'
        required: false
        default: 'Manual test run'
        
  # 2. å®šæ—¶è§¦å‘ (å¯é€‰ï¼Œä¾‹å¦‚æ¯å¤©é›¶ç‚¹è¿è¡Œ)
  schedule:
    # æ¯å¤© 00:00 UTC è¿è¡Œã€‚
    # å¦‚æœå¸Œæœ›åœ¨ä¸Šæµ·æ—¶é—´ 08:00 è¿è¡Œï¼ˆUTC+8ï¼‰ï¼Œåˆ™è®¾ç½®ä¸º 00:00 UTCã€‚
    - cron: '0 0 * * *' 
  
  # 3. å½“å…³é”®æ–‡ä»¶å˜åŠ¨æ—¶è‡ªåŠ¨è§¦å‘ (è‡ªåŠ¨è¿è¡Œ)
  push:
    paths:
      # å½“å·¥ä½œæµæ–‡ä»¶æœ¬èº«æˆ–æµ‹è¯•è„šæœ¬å˜åŠ¨æ—¶è§¦å‘
      - '.github/workflows/connect_test.yml'
      - 'tcp_ping_test.sh'
      # å¦‚æœæƒ³åœ¨ä»»ä½•ä»£ç æ¨é€æ—¶éƒ½è¿è¡Œï¼Œå¯ä»¥æ·»åŠ  '*' æˆ–å…¶ä»–æ–‡ä»¶è·¯å¾„

# å…¨å±€ç¯å¢ƒå˜é‡
env:
  TZ: 'Asia/Shanghai' # è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ·ï¼Œç”¨äºæ—¥å¿—ä¸­çš„æ—¶é—´æˆ³

jobs:
  run_test:
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: æ£€å‡ºä»“åº“ä»£ç 
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4
        
      # Step 2: èµ‹äºˆè„šæœ¬æ‰§è¡Œæƒé™
      - name: âš™ï¸ Set up Permissions
        run: chmod +x tcp_ping_test.sh
        
      # Step 3: æ‰§è¡Œ TCP Ping æµ‹è¯•è„šæœ¬
      - name: ğŸƒ Run TCP Connectivity Test
        # ä¸ºäº†è®©è„šæœ¬è¾“å‡ºæ›´è¯¦ç»†ï¼Œå¹¶é¿å…å¤±è´¥æ—¶ç«‹å³ä¸­æ–­å·¥ä½œæµ
        id: test_script
        run: ./tcp_ping_test.sh | tee script_output.log # ä½¿ç”¨ tee å°†è¾“å‡ºåŒæ—¶å†™å…¥æ—¥å¿—æ–‡ä»¶
        
      # Step 4: æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„è¿é€šèŠ‚ç‚¹æ–‡ä»¶ç”Ÿæˆ
      - name: ğŸ” Check for Working Nodes
        id: check_file
        # æ£€æŸ¥ working_nodes.txt æ˜¯å¦å­˜åœ¨ä¸”ä¸ä¸ºç©º
        run: |
          if [ -s working_nodes.txt ]; then
            echo "::set-output name=file_exists::true"
          else
            echo "::set-output name=file_exists::false"
          fi
          
      # Step 5: å¦‚æœå­˜åœ¨è¿é€šèŠ‚ç‚¹ï¼Œåˆ™æäº¤åˆ°ä»“åº“
      # æ­¤æ­¥éª¤åªåœ¨æ–‡ä»¶å­˜åœ¨ä¸”å†…å®¹å‘ç”Ÿå˜åŒ–æ—¶æ‰§è¡Œ
      - name: ğŸ“¤ Commit Working Nodes
        if: steps.check_file.outputs.file_exists == 'true'
        uses: EndBug/add-and-commit@v9
        with:
          author_name: GitHub Actions Bot
          author_email: actions@github.com
          message: "âœ… Auto update: Working nodes found [$(date +'%Y-%m-%d %H:%M:%S' -d @$(($(date +%s) + 8*3600)))]"
          add: 'working_nodes.txt'
          # å¦‚æœå·¥ä½œæµæ–‡ä»¶æˆ–è„šæœ¬æœ¬èº«å˜åŠ¨ï¼Œä¹Ÿä¸€å¹¶æäº¤
          # files: working_nodes.txt
          
# æ³¨æ„ï¼šæ­¤å·¥ä½œæµ**æ²¡æœ‰**ä½¿ç”¨ artifact åŠŸèƒ½æ¥ä¸Šä¼ æ–‡ä»¶ï¼Œè€Œæ˜¯ç›´æ¥æäº¤åˆ° Git ä»“åº“ï¼Œç¬¦åˆä½ çš„è¦æ±‚ã€‚
