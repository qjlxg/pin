name: Generate and Push Trojan Links

# ------------------------------------------
# è§¦å‘äº‹ä»¶é…ç½®
# ------------------------------------------
on:
  # 1. æ‰‹åŠ¨è§¦å‘ (å¯ä» Actions é¡µé¢ç‚¹å‡» Run workflow æŒ‰é’®è¿è¡Œ)
  workflow_dispatch:
    inputs:
      reason:
        description: 'æ‰‹åŠ¨è¿è¡Œçš„åŸå›  (å¯é€‰)'
        required: false
        default: 'Manual run via GitHub UI'

  # 2. å®šæ—¶è¿è¡Œ (UTC 01:00ï¼Œç›¸å½“äºä¸Šæµ·æ—¶åŒº 09:00)
  schedule:
    - cron: '0 1 * * *' 

  # 3. æ–‡ä»¶å˜åŠ¨è‡ªåŠ¨è¿è¡Œ
  push:
    branches:
      - master # ç¡®ä¿è¿™æ˜¯æ‚¨çš„ä¸»åˆ†æ”¯åç§°
      - main   # å¦‚æœæ‚¨çš„ä¸»åˆ†æ”¯æ˜¯ mainï¼Œè¯·ä¿ç•™
    paths:
      # ç›‘æ§ä»¥ä¸‹æ–‡ä»¶çš„å˜åŠ¨
      - 'link80.txt'
      - 'generate_config_80.py'
      - '.github/workflows/generate_config_80.yml'

# ------------------------------------------
# å…¨å±€æ—¶åŒºè®¾ç½® (ä¸Šæµ·æ—¶åŒº)
# ------------------------------------------
env:
  TZ: Asia/Shanghai

jobs:
  generate_and_push:
    # ä½¿ç”¨æœ€æ–°çš„ Ubuntu è¿è¡Œç¯å¢ƒ
    runs-on: ubuntu-latest
    
    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          # å¿…é¡»è®¾ç½® token å’Œ fetch-depthï¼Œä»¥ä¾¿åç»­èƒ½å¤Ÿæ¨é€
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0 

      # æ­¥éª¤ 2: è®¾ç½® Python ç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x' 

      # æ­¥éª¤ 3: è¿è¡Œ Python è„šæœ¬ç”Ÿæˆé“¾æ¥æ–‡ä»¶
      - name: Run Python Script to Generate Links
        run: |
          echo "Current time in Shanghai: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          python generate_config_80.py
      # æ­¥éª¤ 4: æäº¤å¹¶æ¨é€æ–‡ä»¶å˜åŠ¨ (è§£å†³ä¸Šæ¬¡æ— æ³•æ¨é€çš„é—®é¢˜)
      # ä½¿ç”¨ stefanzweifel/git-auto-commit-action è‡ªåŠ¨å¤„ç†å·®å¼‚å’Œæ¨é€é€»è¾‘
      - name: Commit files and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          # ä»…ç›‘æ§å¹¶æäº¤ trojan_links.txt æ–‡ä»¶
          file_pattern: 'trojan_links_80.txt'
          # è®¾ç½®æäº¤ä¿¡æ¯
          commit_message: 'ğŸ¤– Auto-update: Generated trojan_links.txt'
          # æ¨é€åˆ°å½“å‰è¿è¡Œçš„åˆ†æ”¯
          branch: ${{ github.ref_name }} 
          # è®¾ç½®æ¨é€è€…ä¸º GitHub å®˜æ–¹ Bot
          commit_user_name: 'github-actions[bot]'
          commit_user_email: 'github-actions[bot]@users.noreply.github.com'
          # åªæœ‰æ–‡ä»¶æœ‰å®é™…å˜åŒ–æ—¶æ‰æäº¤
          skip_if_no_change: true
