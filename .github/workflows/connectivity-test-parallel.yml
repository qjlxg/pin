# .github/workflows/connectivity-test-parallel.yml
name: æµ‹è¯• (å¹¶è¡ŒåŠ é€Ÿ)

on:
  # 1. å…è®¸æ‰‹åŠ¨è¿è¡Œ (æ— è¾“å…¥å‚æ•°)
  workflow_dispatch:
  
  # 2. è„šæœ¬æˆ–æ ¸å¿ƒæ–‡ä»¶å˜åŠ¨æ—¶è‡ªåŠ¨è§¦å‘
  push:
    branches:
      - main # è¯·æ ¹æ®æ‚¨çš„ä¸»åˆ†æ”¯åç§°è¿›è¡Œä¿®æ”¹
    paths:
      - 'test_connectivity_parallel.py' # ç¡®ä¿è„šæœ¬æ›´æ–°æ—¶è§¦å‘
      - 'mihomo-linux-amd64' # ç¡®ä¿æ ¸å¿ƒæ–‡ä»¶æ›´æ–°æ—¶è§¦å‘
      - '.github/workflows/connectivity-test-parallel.yml'
      
jobs:
  test_and_push:
    runs-on: ubuntu-latest
    
    # æˆäºˆå†™å…¥æƒé™ï¼Œå…è®¸ github-actions[bot] æ¨é€æ–°çš„æäº¤
    permissions:
      contents: write 
    
    # è®¾ç½®ä¸Šæµ·æ—¶åŒº
    env:
      TZ: 'Asia/Shanghai'

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          # fetch-depth: 0 å…è®¸åç»­æ­¥éª¤æ¨é€æ–°çš„æäº¤
          fetch-depth: 0 
          
      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: âš™ï¸ å®‰è£…ä¾èµ– (requests, pytz)
        run: |
          pip install requests pytz
          
      - name: ğŸ’¾ æ£€æŸ¥ Mihomo æ ¸å¿ƒå¹¶æˆæƒ
        run: |
          MIHOMO_EXEC="./mihomo-linux-amd64"
          if [ ! -f "$MIHOMO_EXEC" ]; then
            echo "::error::Mihomo æ ¸å¿ƒæ–‡ä»¶ $MIHOMO_EXEC æœªæ‰¾åˆ°ï¼Œè¯·ç¡®ä¿å·²ä¸Šä¼ åˆ°ä»“åº“æ ¹ç›®å½•ã€‚"
            exit 1
          fi
          # ç¡®ä¿ Mihomo æ ¸å¿ƒæœ‰æ‰§è¡Œæƒé™ï¼Œä¾›å¹¶è¡Œè„šæœ¬è°ƒç”¨
          chmod +x "$MIHOMO_EXEC"
          echo "âœ… Mihomo æ ¸å¿ƒæ£€æŸ¥æˆåŠŸï¼Œå·²æˆæƒæ‰§è¡Œã€‚"

      - name: ğŸƒ æ‰§è¡Œå¹¶è¡Œè¿é€šæ€§æµ‹è¯•è„šæœ¬
        id: run-script
        run: |
          # è¿è¡Œè„šæœ¬
          python test_connectivity_parallel.py | tee run_output.txt
          
          # ä»è„šæœ¬è¾“å‡ºä¸­æå– REPORT_PATH å˜é‡
          REPORT_PATH=$(grep 'REPORT_PATH=' run_output.txt | cut -d'=' -f2)
          echo "REPORT_PATH=$REPORT_PATH" >> $GITHUB_OUTPUT
        
      - name: â¬†ï¸ æ¨é€æµ‹è¯•ç»“æœåˆ°ä»“åº“ (å·²ä¿®å¤å†²çªé—®é¢˜)
        if: steps.run-script.outputs.REPORT_PATH != ''
        run: |
          REPORT_PATH=${{ steps.run-script.outputs.REPORT_PATH }}
          
          if [ ! -f "$REPORT_PATH" ]; then
            echo "âŒ æŠ¥å‘Šæ–‡ä»¶æœªæ‰¾åˆ°ï¼Œè·³è¿‡æ¨é€ã€‚"
            exit 0
          fi
          
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          
          git add $REPORT_PATH
          
          if ! git diff-index --quiet HEAD; then
            DATE_SHANGHAI=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')
            git commit -m "è‡ªåŠ¨æµ‹è¯•: æˆåŠŸèŠ‚ç‚¹æŠ¥å‘Š ${DATE_SHANGHAI} (å¹¶è¡Œæµ‹è¯•)"
            
            # === å…³é”®ä¿®å¤ï¼šåœ¨æ¨é€å‰æ‹‰å–è¿œç¨‹ä»£ç å¹¶å˜åŸºï¼Œè§£å†³ 'rejected' é”™è¯¯ ===
            git pull --rebase origin ${GITHUB_REF#refs/heads/} 
            git push
          else
            echo "æŠ¥å‘Šæ–‡ä»¶æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤ã€‚"
          fi
