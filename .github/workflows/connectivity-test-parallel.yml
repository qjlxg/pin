# .github/workflows/connectivity-test-clash.yml
name: æµ‹è¯• (Clash ä¸“ä¸šè¿é€šæ€§)

on:
  # 1. å…è®¸æ‰‹åŠ¨è¿è¡Œ (æ— è¾“å…¥å‚æ•°)
  workflow_dispatch:
  
  # 2. è„šæœ¬æˆ–å·¥ä½œæµå˜åŠ¨æ—¶è‡ªåŠ¨è§¦å‘
  push:
    branches:
      - main
    paths:
      - 'test_connectivity_clash.py'
      - '.github/workflows/connectivity-test-clash.yml'
      
jobs:
  test_and_push:
    runs-on: ubuntu-latest
    
    # æˆäºˆå†™å…¥æƒé™ï¼Œè§£å†³ 403 æƒé™é”™è¯¯
    permissions:
      contents: write # å…è®¸ github-actions[bot] æ¨é€æ–°çš„æäº¤
    
    # è®¾ç½®ä¸Šæµ·æ—¶åŒº
    env:
      TZ: 'Asia/Shanghai'

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          # å…è®¸åç»­æ­¥éª¤æ¨é€æ–°çš„æäº¤
          fetch-depth: 0 
          
      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: âš™ï¸ å®‰è£…ä¾èµ– (requests, pytz)
        run: |
          pip install requests pytz
          
      - name: ğŸƒ æ‰§è¡Œ Clash è¿é€šæ€§æµ‹è¯•è„šæœ¬
        id: run-script
        run: |
          # è¿è¡Œè„šæœ¬
          python test_connectivity_clash.py | tee run_output.txt
          
          # ä»è„šæœ¬è¾“å‡ºä¸­æå– REPORT_PATH å˜é‡
          REPORT_PATH=$(grep 'REPORT_PATH=' run_output.txt | cut -d'=' -f2)
          echo "REPORT_PATH=$REPORT_PATH" >> $GITHUB_OUTPUT
        
      - name: â¬†ï¸ æ¨é€æµ‹è¯•ç»“æœåˆ°ä»“åº“
        if: steps.run-script.outputs.REPORT_PATH != ''
        run: |
          REPORT_PATH=${{ steps.run-script.outputs.REPORT_PATH }}
          
          if [ ! -f "$REPORT_PATH" ]; then
            echo "âŒ æŠ¥å‘Šæ–‡ä»¶æœªæ‰¾åˆ°ï¼Œè·³è¿‡æ¨é€ã€‚"
            exit 0
          fi
          
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          
          git add $REPORT_PATH
          
          if ! git diff-index --quiet HEAD; then
            DATE_SHANGHAI=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')
            git commit -m "è‡ªåŠ¨æµ‹è¯•: Clash å¯ç”¨èŠ‚ç‚¹æŠ¥å‘Š ${DATE_SHANGHAI} (ä¸Šæµ·æ—¶åŒº)"
            
            # åœ¨æ¨é€å‰æ‹‰å–è¿œç¨‹ä»£ç å¹¶å˜åŸº
            git pull --rebase origin main 
            
            git push
            echo "âœ… æˆåŠŸæ¨é€äº†æ–°æŠ¥å‘Š: $REPORT_PATH"
          else
            echo "âš ï¸ ä»“åº“ä¸­æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹ã€‚"
          fi
