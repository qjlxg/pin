# .github/workflows/connectivity-test-parallel.yml
name: æµ‹è¯• (å¹¶è¡ŒåŠ é€Ÿ)

on:
  # 1. å…è®¸æ‰‹åŠ¨è¿è¡Œ (å·²å»é™¤åŸå› è¾“å…¥)
  workflow_dispatch:
  
  # 2. è„šæœ¬å˜åŠ¨æ—¶è‡ªåŠ¨è§¦å‘
  push:
    branches:
      - main # è¯·æ ¹æ®æ‚¨çš„ä¸»åˆ†æ”¯åç§°è¿›è¡Œä¿®æ”¹
    paths:
      - 'test_connectivity_parallel.py'
      - '.github/workflows/connectivity-test-parallel.yml'
      
jobs:
  test_and_push:
    runs-on: ubuntu-latest
    
    # æˆäºˆå†™å…¥æƒé™ï¼Œè§£å†³ 403 æƒé™é”™è¯¯
    permissions:
      contents: write # å…è®¸ github-actions[bot] æ¨é€æ–°çš„æäº¤
    
    # è®¾ç½®ä¸Šæµ·æ—¶åŒº
    env:
      TZ: 'Asia/Shanghai'

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          # å…è®¸åç»­æ­¥éª¤æ¨é€æ–°çš„æäº¤
          fetch-depth: 0 
          
      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: âš™ï¸ å®‰è£…ä¾èµ– (requests, pytz)
        run: |
          # requests ç”¨äºä¸‹è½½è¿œç¨‹æ–‡ä»¶
          # pytz ç”¨äºå¤„ç†ä¸Šæµ·æ—¶åŒº
          pip install requests pytz
          # ç¡®ä¿ Netcat (nc) å‘½ä»¤å¯ç”¨ï¼Œubuntu-latest é»˜è®¤åŒ…å«
          
      - name: ğŸƒ æ‰§è¡Œå¹¶è¡Œè¿é€šæ€§æµ‹è¯•è„šæœ¬
        id: run-script
        # è¿è¡Œè„šæœ¬å¹¶å°†è¾“å‡ºä¿å­˜åˆ° run_output.txtï¼ŒåŒæ—¶æ‰“å°åˆ°æ§åˆ¶å°
        run: |
          python test_connectivity_parallel.py | tee run_output.txt
          
          # ä»è„šæœ¬è¾“å‡ºä¸­æå– REPORT_PATH å˜é‡ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          REPORT_PATH=$(grep 'REPORT_PATH=' run_output.txt | cut -d'=' -f2)
          # æ³¨æ„ï¼šGitHub Actions ç¯å¢ƒä¸­ï¼Œå¯¹äºé setup-python ç­‰ç‰¹æ®Š actionï¼Œ
          # æ¨èä½¿ç”¨ echo "VAR=VALUE" >> $GITHUB_OUTPUT æ–¹å¼æ¥è®¾ç½®è¾“å‡ºå˜é‡ã€‚
          echo "REPORT_PATH=$REPORT_PATH" >> $GITHUB_OUTPUT
        
      - name: â¬†ï¸ æ¨é€æµ‹è¯•ç»“æœåˆ°ä»“åº“
        # åªæœ‰è„šæœ¬æˆåŠŸè¾“å‡ºäº† REPORT_PATH æ‰ä¼šæ‰§è¡Œåç»­æ­¥éª¤
        if: steps.run-script.outputs.REPORT_PATH != ''
        run: |
          REPORT_PATH=${{ steps.run-script.outputs.REPORT_PATH }}
          
          # æ£€æŸ¥æŠ¥å‘Šæ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "$REPORT_PATH" ]; then
            echo "âŒ æŠ¥å‘Šæ–‡ä»¶æœªæ‰¾åˆ°ï¼Œè·³è¿‡æ¨é€ã€‚"
            exit 0
          fi
          
          # é…ç½® git ç”¨æˆ·ä¿¡æ¯
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          
          # æ·»åŠ å…¥æ–°ç”Ÿæˆçš„æŠ¥å‘Šæ–‡ä»¶åŠå…¶æ‰€åœ¨çš„å¹´æœˆç›®å½•
          git add $REPORT_PATH
          
          # æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦æäº¤çš„æ›´æ”¹
          if ! git diff-index --quiet HEAD; then
            DATE_SHANGHAI=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')
            git commit -m "è‡ªåŠ¨æµ‹è¯•: æˆåŠŸèŠ‚ç‚¹æŠ¥å‘Š ${DATE_SHANGHAI} (ä¸Šæµ·æ—¶åŒº)"
            git push
            echo "âœ… æˆåŠŸæ¨é€äº†æ–°æŠ¥å‘Š: $REPORT_PATH"
          else
            echo "âš ï¸ ä»“åº“ä¸­æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹ã€‚"
          fi
